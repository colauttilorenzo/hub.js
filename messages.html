<html>

<head>
    <title>Messages</title>
</head>

<body>

    <script type="text/javascript">

        (function () {

            window.message = new function () {

                var _DEFAULT_KEY = '_';
                var _hub = {};

                _hub[_DEFAULT_KEY] = {};

                var _message = function (chanel) {

                    if (chanel == undefined || (chanel != undefined && chanel.replace(/ /gm) == '')) {
                        chanel = _DEFAULT_KEY;
                    }

                    this.instance = function (chanel) {

                        var chanel = chanel;
                        var createParameter = function (chanel, message, data) {
                            return {
                                event: { chanel: chanel, message: message },
                                data: data
                            };
                        };

                        this.publish = function (message, data) {
                            //TODO: check if _hub[chanel] exists
                            //TODO: check if _hub[chanel][message] exists
                            var param = createParameter(chanel, message, data);
                            for (var i = 0; i < _hub[chanel][message].length; i++) {
                                _hub[chanel][message][i](param);
                            }

                            delete param;
                        };

                        if (chanel == _DEFAULT_KEY) {
                            this.broadcast = function (message, data) {
                                //TODO: check if _hub[chanel] exists
                                //TODO: check if _hub[chanel][message] exists
                                for (var __key in _hub) {
                                    if (_hub[__key][message] != undefined) {
                                        var param = createParameter(__key, message, data);
                                        for (var i = 0; i < _hub[__key][message].length; i++) {
                                            _hub[__key][message][i](param);
                                        }
                                    }
                                }

                                delete param;
                            };
                        }

                        this.subscribe = function (message, handler) {
                            //TODO: check if _hub[chanel] exists
                            //TODO: check if _hub[chanel][message] exists
                            if (_hub[chanel][message] == undefined) {
                                _hub[chanel][message] = [];
                            }

                            _hub[chanel][message].push(handler);
                        };

                        this.unsubscribe = function (message) {
                            //TODO: check if _hub[chanel] exists
                            //TODO: check if _hub[chanel][message] exists
                            delete _hub[chanel][message];
                        };

                        this.clone = function (newName) {
                            //TODO: check if _hub[chanel] exists
                            if (_hub[newName] == undefined) {
                                _hub[newName] = Object.assign({}, _hub[chanel]);
                            }
                            else {
                                //TODO: warning ...key already exists
                            }
                        };

                        this.dispose = function () {
                            if (chanel == undefined || (chanel != undefined && chanel.replace(/ /gm) == '')) {
                                //TODO: warning ...chanel not defined or empty
                                return;
                            }

                            if (chanel == _DEFAULT_KEY) {
                                //TODO: warning ...chanel could not be default
                                return;
                            }

                            if (_hub[chanel] != undefined) {
                                _hub[chanel] = undefined;
                                delete _hub[chanel];
                            }
                            else {
                                //TODO: warning ...key not found
                            }
                        };

                    };

                    return new instance(chanel);

                };

                var me = this;

                me.chanels = {

                    create: function (name) {
                        if (_hub[name] == undefined) {
                            _hub[name] = Object.assign({}, _hub[_DEFAULT_KEY]);
                        }
                        else {
                            //TODO: warning ...key already exists
                        }
                    },

                    get: function () {
                        return Object.keys(_hub);
                    }

                };

                me.message = _message(_DEFAULT_KEY);

                me.useChanel = function (name) {
                    return _message(name);
                };

                return {
                    chanels: me.chanels,
                    use: me.useChanel,
                    subscribe: me.message.subscribe,
                    unsubscribe: me.message.unsubscribe,
                    publish: me.message.publish,
                    broadcast: me.message.broadcast
                };

            };

        })();

        /*
        message.chanels.create('test');             // crea il canale 'test'
        message.chanels.create('test02');           // crea il canale 'test02'
        message.chanels.create('test03');           // crea il canale 'test03'

        // ottiene tutti i canali registrati
        message.chanels.get();

        // sul canale di default
        message.subscribe('message01', function (param) { });
        message.publish('message01');
        message.unsubscribe('message01');

        // broadcast su tutti i canali, compreso quello di default
        message.broadcast('message01');

        // su un canale specifico
        message.use('test').subscribe('message-test', function (param) { });
        message.use('test').publish('message-test');
        message.use('test').unsubscribe('message-test');

        // elimina il canale 'test03'
        message.use('test03').dispose();

        // clona il canale 'test02' creando il nuovo canale 'test03'
        message.use('test').clone('test03');
        */


    </script>
</body>

</html>